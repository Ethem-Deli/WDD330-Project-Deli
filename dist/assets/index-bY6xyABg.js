import{getApps as d,initializeApp as h}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";import{getAuth as y}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";import{getFirestore as v,doc as g,getDoc as b}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const t of n)if(t.type==="childList")for(const i of t.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const t={};return n.integrity&&(t.integrity=n.integrity),n.referrerPolicy&&(t.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?t.credentials="include":n.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(n){if(n.ep)return;n.ep=!0;const t=o(n);fetch(n.href,t)}})();function w(){const e=document.querySelectorAll(".event-card");if(!e.length)return;const r=new IntersectionObserver((o,a)=>{o.forEach(n=>{n.isIntersecting&&(n.target.classList.add("animate-in"),a.unobserve(n.target))})},{threshold:.2});e.forEach(o=>r.observe(o))}async function L(e="World History"){try{const r=`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages|extracts&exintro&explaintext&pithumbsize=500&generator=search&gsrsearch=${encodeURIComponent(e)}&gsrlimit=15`,a=await(await fetch(r)).json();return a.query?Object.values(a.query.pages).map((n,t)=>({id:n.pageid||t+1,title:n.title,description:n.extract?n.extract.slice(0,300):"No description available for this event.",image:n.thumbnail?.source||"./src/assets/placeholder.png",year:E(n.extract)||1900+t,theme:F(n.title+" "+n.extract),lat:null,lng:null})):[]}catch(r){return console.error("‚ùå fetchEvents failed:",r),[]}}function E(e=""){const r=e.match(/\b(1[5-9]\d{2}|20\d{2})\b/);return r?parseInt(r[0]):null}function F(e=""){return e=e.toLowerCase(),e.includes("war")?"war":e.includes("revolution")?"revolution":e.includes("flight")||e.includes("technology")||e.includes("invention")?"technology":e.includes("exploration")||e.includes("discovery")?"exploration":"general"}const I={apiKey:"AIzaSyB92OXlJn50jta9IHuY5czC937HMgYH2xs",authDomain:"historytimeline-wdd330.firebaseapp.com",projectId:"historytimeline-wdd330",storageBucket:"historytimeline-wdd330.appspot.com",messagingSenderId:"539673015003",appId:"1:539673015003:web:2621f434393950b78312fe",measurementId:"G-GV6LHVLN1R"},f=d().length?d()[0]:h(I),x=y(f),S=v(f),s=window.showToast||(e=>alert(e)),p="favorites_v1";function c(){try{return JSON.parse(localStorage.getItem(p)||"[]")}catch{return[]}}function A(e){try{localStorage.setItem(p,JSON.stringify(e||[]))}catch(r){console.error("Failed saving local favorites:",r)}}async function B(){try{const e=x.currentUser;if(!e)return null;const r=g(S,"favorites",e.uid),o=await b(r);return o.exists()?o.data().items||[]:[]}catch(e){return console.warn("firebaseGetFavorites failed:",e),null}}async function O(){const e=await B();return Array.isArray(e)?e:c()}function k(){const e=c(),r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download="favorites.json",a.click(),URL.revokeObjectURL(o)}async function $(){const e=c(),r=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),o=`${location.origin}${location.pathname}?shared=${r}`;return await navigator.clipboard.writeText(o),s("üìã Share link copied to clipboard!"),o}function j(){const e=new URLSearchParams(location.search);if(!e.has("shared"))return!1;try{const r=decodeURIComponent(escape(atob(e.get("shared")))),o=JSON.parse(r);return A(o),s("‚úÖ Imported shared favorites!"),!0}catch(r){return console.error("loadSharedFavoritesFromQuery failed:",r),s("‚ùå Failed to import shared favorites."),!1}}function T(){const e=document.getElementById("hamburgerBtn"),r=document.getElementById("navMenu");!e||!r||(e.addEventListener("click",o=>{o.stopPropagation(),r.classList.toggle("open"),e.classList.toggle("active")}),r.querySelectorAll("a").forEach(o=>{o.addEventListener("click",()=>{r.classList.remove("open"),e.classList.remove("active")})}),document.addEventListener("click",o=>{!r.contains(o.target)&&!e.contains(o.target)&&(r.classList.remove("open"),e.classList.remove("active"))}))}function l(e,r="info",o=3e3){try{const a="toast-container";let n=document.getElementById(a);n||(n=document.createElement("div"),n.id=a,n.style.position="fixed",n.style.right="1rem",n.style.top="1rem",n.style.zIndex=99999,n.style.display="flex",n.style.flexDirection="column",n.style.gap="8px",document.body.appendChild(n));const t=document.createElement("div");t.className=`toast toast-${r}`,t.textContent=e,t.style.padding="10px 14px",t.style.borderRadius="8px",t.style.boxShadow="0 6px 20px rgba(0,0,0,0.12)",t.style.maxWidth="360px",t.style.fontSize="0.95rem",t.style.opacity="0",t.style.transform="translateY(-6px)",t.style.transition="opacity .18s, transform .18s",r==="success"?(t.style.background="#ecfdf5",t.style.color="#065f46"):r==="error"?(t.style.background="#fff1f2",t.style.color="#7f1d1d"):(t.style.background="#f3f4f6",t.style.color="#111827"),n.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1",t.style.transform="translateY(0)"}),setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-6px)",setTimeout(()=>t.remove(),220)},o)}catch(a){console.warn("toast error",a)}}window.showToast=l;let u=[];async function m(e,r){const o=document.getElementById(r);if(!o)return;const a=await fetch(e);o.innerHTML=await a.text()}function N(e=[]){const r=document.getElementById("timelineList");if(r){if(!e||e.length===0){r.innerHTML='<p class="no-results">No events found for your search.</p>';return}r.innerHTML=e.map(o=>`
      <div class="event-card" data-id="${o.id}">
        <img src="${o.image}" alt="${o.title}" class="event-image">
        <div class="card-body">
          <h3>${o.title}</h3>
          <p>${(o.description||"").slice(0,100)}...</p>
        </div>
        <button class="favorite-btn" title="Favorite">‚ù§Ô∏è</button>
      </div>`).join(""),w()}}async function C(){const e=await O(),r=document.getElementById("favoritesList");r&&(r.innerHTML=`
    <div class="favorites-header">
      <h3>Your Favorites</h3>
      <div class="fav-actions">
        <button id="exportFavsBtn" class="btn-small">‚¨áÔ∏è Export</button>
        <button id="shareFavsBtn" class="btn-small">üîó Share</button>
      </div>
    </div>
    ${e.length?e.map(o=>`
              <div class="event-card small" data-id="${o.id}">
                <img src="${o.image}" alt="${o.title}" class="event-image-small">
                <div class="card-body"><h4>${o.title}</h4></div>
              </div>`).join(""):"<p>No favorites yet ‚ù§Ô∏è</p>"}
  `,document.getElementById("exportFavsBtn")?.addEventListener("click",k),document.getElementById("shareFavsBtn")?.addEventListener("click",async()=>{await $(),l("üìã Share link copied to clipboard!","success")}))}document.addEventListener("DOMContentLoaded",async()=>{await m("./src/partials/header.html","header-placeholder"),await m("./src/partials/footer.html","footer-placeholder"),T(),j();try{const r=await(await fetch("./data/events.json")).json();let o=[];try{o=await L("World History")}catch(t){console.warn("API fetch failed:",t)}const a=[...r.slice(0,10),...o.slice(0,10)];u=[...[{id:9991,title:"Moon Landing",description:"Apollo 11 (1969).",image:"https://upload.wikimedia.org/wikipedia/commons/9/9c/Aldrin_Apollo_11.jpg",year:1969,lat:.67408,lng:23.47297,theme:"technology"},{id:9992,title:"French Revolution",description:"1789 - 1799.",image:"https://upload.wikimedia.org/wikipedia/commons/6/6f/Prise_de_la_Bastille.jpg",year:1789,lat:48.8566,lng:2.3522,theme:"revolution"}],...a].map((t,i)=>({id:t.id||i+1,title:t.title||"Untitled Event",description:t.description||"No description available.",image:t.image||"./src/assets/placeholder.png",year:t.year||null,lat:t.lat||null,lng:t.lng||null,theme:t.theme||"general"})),N(u),await C()}catch(e){console.error("main load error",e),l("Failed to load events","error")}});
