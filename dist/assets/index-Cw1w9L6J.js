import{getApps as v,initializeApp as A}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";import{getAuth as O}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";import{getFirestore as R,doc as k,getDoc as U,setDoc as j}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();function H(e,o){const t=document.getElementById("globalSearch"),a=document.getElementById("searchBtn");if(!t||!a){console.warn("üîç Search input or button not found in header.");return}const r=()=>{const n=t.value.trim().toLowerCase();if(!n){o(e);return}const i=e.filter(s=>{const d=s.title?.toLowerCase()||"",u=s.description?.toLowerCase()||"",g=s.year?.toString()||"",l=s.theme?.toLowerCase()||"";return d.includes(n)||u.includes(n)||g.includes(n)||l.includes(n)});o(i)};t.addEventListener("input",r),a.addEventListener("click",r)}function q(){const e=document.querySelectorAll(".event-card");if(!e.length)return;const o=new IntersectionObserver((t,a)=>{t.forEach(r=>{r.isIntersecting&&(r.target.classList.add("animate-in"),a.unobserve(r.target))})},{threshold:.2});e.forEach(t=>o.observe(t))}async function _(e="World History"){try{const o=`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages|extracts&exintro&explaintext&pithumbsize=500&generator=search&gsrsearch=${encodeURIComponent(e)}&gsrlimit=15`,a=await(await fetch(o)).json();if(!a.query){console.warn("‚ö†Ô∏è No Wikipedia data, falling back to local JSON");const r=await fetch("data/events.json");if(!r.ok)throw new Error("Local JSON not found");return await r.json()}return Object.values(a.query.pages).map((r,n)=>({id:r.pageid||n+1,title:r.title,description:r.extract?r.extract.slice(0,300):"No description available for this event.",image:r.thumbnail?.source||"assets/placeholder.png",year:P(r.extract)||1900+n,theme:J(r.title+" "+r.extract),lat:null,lng:null}))}catch(o){console.error("‚ùå fetchEvents failed:",o);try{const t=await fetch("data/events.json");if(!t.ok)throw new Error("Fallback JSON failed");return await t.json()}catch(t){return console.error("‚ùå Local fetch also failed:",t),[]}}}function P(e=""){const o=e.match(/\b(1[5-9]\d{2}|20\d{2})\b/);return o?parseInt(o[0]):null}function J(e=""){return e=e.toLowerCase(),e.includes("war")?"war":e.includes("revolution")?"revolution":e.includes("flight")||e.includes("technology")||e.includes("invention")?"technology":e.includes("exploration")||e.includes("discovery")?"exploration":"general"}function z(e,o=1e4){return new Promise((t,a)=>{if(window.google&&window.google.maps&&window.google.maps.importLibrary){t(window.google);return}const r=document.querySelector("script[data-google-maps-loader]");if(r){r.addEventListener("load",()=>{window.google?t(window.google):a(new Error("Google loaded but window.google missing"))}),r.addEventListener("error",a);return}const n="_gmaps_loader_callback_"+Date.now();window[n]=()=>{delete window[n],t(window.google)};const i=document.createElement("script");i.dataset.googleMapsLoader="1",i.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(e)}&callback=${n}&libraries=maps,marker`,i.async=!0,i.defer=!0,i.onerror=s=>{delete window[n],a(s)},document.head.appendChild(i),setTimeout(()=>{window.google||a(new Error("Google Maps load timeout"))},o)})}const G={apiKey:"AIzaSyB92OXlJn50jta9IHuY5czC937HMgYH2xs",authDomain:"historytimeline-wdd330.firebaseapp.com",projectId:"historytimeline-wdd330",storageBucket:"historytimeline-wdd330.appspot.com",messagingSenderId:"539673015003",appId:"1:539673015003:web:2621f434393950b78312fe",measurementId:"G-GV6LHVLN1R"},I=v().length?v()[0]:A(G),F=O(I),S=R(I),p=window.showToast||(e=>alert(e)),x="favorites_v1";function y(){try{return JSON.parse(localStorage.getItem(x)||"[]")}catch{return[]}}function B(e){try{localStorage.setItem(x,JSON.stringify(e||[]))}catch(o){console.error("Failed saving local favorites:",o)}}async function Y(){try{const e=F.currentUser;if(!e)return null;const o=k(S,"favorites",e.uid),t=await U(o);return t.exists()?t.data().items||[]:[]}catch(e){return console.warn("firebaseGetFavorites failed:",e),null}}async function C(){const e=await Y();return Array.isArray(e)?e:y()}async function w(e){try{const o=F.currentUser;if(B(e),o)try{const t=k(S,"favorites",o.uid);await j(t,{items:e},{merge:!0}),p("‚úÖ Synced to your online favorites!","success")}catch(t){console.warn("Firestore save failed, falling back to local only:",t),p("‚ö†Ô∏è Saved locally (offline mode)","info")}else p("‚≠ê Saved locally (login to sync!)","info")}catch(o){console.error("Error saving favorites:",o),p("‚ùå Failed to save favorite.","error")}}function K(){const e=y(),o=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=URL.createObjectURL(o),a=document.createElement("a");a.href=t,a.download="favorites.json",a.click(),URL.revokeObjectURL(t)}async function V(){const e=y(),o=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),t=`${location.origin}${location.pathname}?shared=${o}`;return await navigator.clipboard.writeText(t),p("üìã Share link copied to clipboard!"),t}function D(){const e=new URLSearchParams(location.search);if(!e.has("shared"))return!1;try{const o=decodeURIComponent(escape(atob(e.get("shared")))),t=JSON.parse(o);return B(t),p("‚úÖ Imported shared favorites!"),!0}catch(o){return console.error("loadSharedFavoritesFromQuery failed:",o),p("‚ùå Failed to import shared favorites."),!1}}function W(){const e=document.getElementById("hamburgerBtn"),o=document.getElementById("navMenu");!e||!o||(e.addEventListener("click",t=>{t.stopPropagation(),o.classList.toggle("open"),e.classList.toggle("active")}),o.querySelectorAll("a").forEach(t=>{t.addEventListener("click",()=>{o.classList.remove("open"),e.classList.remove("active")})}),document.addEventListener("click",t=>{!o.contains(t.target)&&!e.contains(t.target)&&(o.classList.remove("open"),e.classList.remove("active"))}))}function m(e,o="info",t=3e3){try{const a="toast-container";let r=document.getElementById(a);r||(r=document.createElement("div"),r.id=a,r.style.position="fixed",r.style.right="1rem",r.style.top="1rem",r.style.zIndex=99999,r.style.display="flex",r.style.flexDirection="column",r.style.gap="8px",document.body.appendChild(r));const n=document.createElement("div");n.className=`toast toast-${o}`,n.textContent=e,n.style.padding="10px 14px",n.style.borderRadius="8px",n.style.boxShadow="0 6px 20px rgba(0,0,0,0.12)",n.style.maxWidth="360px",n.style.fontSize="0.95rem",n.style.opacity="0",n.style.transform="translateY(-6px)",n.style.transition="opacity .18s, transform .18s",o==="success"?(n.style.background="#ecfdf5",n.style.color="#065f46"):o==="error"?(n.style.background="#fff1f2",n.style.color="#7f1d1d"):(n.style.background="#f3f4f6",n.style.color="#111827"),r.appendChild(n),requestAnimationFrame(()=>{n.style.opacity="1",n.style.transform="translateY(0)"}),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(-6px)",setTimeout(()=>n.remove(),220)},t)}catch(a){console.warn("toast error",a)}}function Q(e=[]){const o=document.querySelector("#timeline");o&&(o.innerHTML="",e.forEach(t=>{const a=document.createElement("div");a.className="timeline-card bg-white rounded-lg shadow p-4 mb-4 transition hover:shadow-lg",a.innerHTML=`
      <h3 class="font-serif text-xl font-bold mb-2">${t.title||"Untitled Event"}</h3>
      <p class="text-gray-700 mb-2">${t.date||"Unknown Date"}</p>
      <p class="text-gray-600 mb-3">${t.description||"No description available."}</p>
      ${t.image?`<img src="${t.image}" alt="${t.title}" class="w-full rounded mb-3">`:""}
      <button class="show-map bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
        View on Map
      </button>
    `,a.querySelector(".show-map").addEventListener("click",()=>{t.lat&&t.lng?renderMapForEvent(t.lat,t.lng,t.title):alert("Location not available for this event.")}),o.appendChild(a)}))}function X(e,o){return o?e.filter(t=>{const a=o.toLowerCase();return t.title?.toLowerCase().includes(a)||t.description?.toLowerCase().includes(a)}):e}function b(e){const o=document.querySelector("#searchInput");o&&o.addEventListener("input",t=>{const a=X(e,t.target.value);Q(a)})}window.showToast=m;const L="AIzaSyDLwMRu47yXHBbfX4cimCx9BnIEtdmd0zk";let f=[];async function E(e,o){const t=document.getElementById(o);if(!t)return;const a=await fetch(e);t.innerHTML=await a.text()}function M(e=[]){const o=document.getElementById("timelineList");if(o){if(!e||e.length===0){o.innerHTML='<p class="no-results">No events found for your search.</p>';return}o.innerHTML=e.map(t=>`
      <div class="event-card" data-id="${t.id}">
        <img src="${t.image}" alt="${t.title}" class="event-image">
        <div class="card-body">
          <h3>${t.title}</h3>
          <p>${(t.description||"").slice(0,100)}...</p>
        </div>
        <button class="favorite-btn" title="Favorite">‚ù§Ô∏è</button>
      </div>`).join(""),q()}}async function N(){const e=await C(),o=document.getElementById("favoritesList");o&&(o.innerHTML=`
    <div class="favorites-header">
      <h3>Your Favorites</h3>
      <div class="fav-actions">
        <button id="exportFavsBtn" class="btn-small">‚¨áÔ∏è Export</button>
        <button id="shareFavsBtn" class="btn-small">üîó Share</button>
      </div>
    </div>
    ${e.length?e.map(t=>`
              <div class="event-card small" data-id="${t.id}">
                <img src="${t.image}" alt="${t.title}" class="event-image-small">
                <div class="card-body"><h4>${t.title}</h4></div>
              </div>`).join(""):"<p>No favorites yet ‚ù§Ô∏è</p>"}
  `,document.getElementById("exportFavsBtn")?.addEventListener("click",K),document.getElementById("shareFavsBtn")?.addEventListener("click",async()=>{await V(),m("üìã Share link copied to clipboard!","success")}),Z(e))}function Z(e){document.querySelectorAll("#favoritesList .event-card.small").forEach(t=>{t.addEventListener("click",a=>{a.stopPropagation();const r=Number(t.dataset.id),n=e.find(i=>i&&i.id===r);n&&$(n)})})}async function $(e){const o=document.getElementById("eventModal");if(!o||!e)return;const t=document.getElementById("modalTitle"),a=document.getElementById("modalImage"),r=document.getElementById("modalDescription"),n=document.getElementById("modalMap"),i=document.getElementById("modalFooter");t.textContent=e.title||"",a.src=e.image||"./src/assets/placeholder.png",r.textContent=e.description||"No description available.",n.innerHTML="Loading map...",i&&(i.innerHTML=""),o.style.display="block";try{await z(L);const{Map:s}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:d}=await google.maps.importLibrary("marker");let{lat:u,lng:g}=e;if(!u||!g)try{const h=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(e.title)}&key=${L}`)).json();if(h.status==="OK"&&h.results?.[0]){const c=h.results[0].geometry.location;u=c.lat,g=c.lng}}catch(l){console.warn("Geocode fallback failed",l)}if(u&&g){const l={lat:Number(u),lng:Number(g)},h=new s(n,{zoom:5,center:l});new d({map:h,position:l,title:e.title});const c=document.createElement("a");c.href=`https://www.google.com/maps?q=${l.lat},${l.lng}`,c.target="_blank",c.rel="noopener",c.textContent="üìç View on Google Maps",c.style.display="inline-block",c.style.marginTop="8px",n.appendChild(c)}else n.innerHTML="<p>Location not available.</p>"}catch(s){console.error("Map render failed",s),n.innerHTML="<p>Map could not be loaded.</p>"}i&&(i.innerHTML='<button id="shareEventBtn" class="btn-small">üîó Share this event</button>',document.getElementById("shareEventBtn")?.addEventListener("click",()=>{try{const d=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),u=`${location.origin}${location.pathname}?event=${d}`;navigator.clipboard.writeText(u),m("Event link copied to clipboard!","success")}catch{m("Failed to create share link","error")}}))}function ee(e){try{typeof b=="function"?b(e,o=>{f=o,M(f),T(f)}):H(e)}catch(o){console.warn("Filter initialization failed:",o)}}async function te(e){try{const o=await C();if(o.find(a=>a&&a.id===e.id)){const a=o.filter(r=>r&&r.id!==e.id);await w(a),m("‚ùå Removed from favorites","error")}else o.push(e),await w(o),m("‚úÖ Added to favorites","success");await N()}catch(o){console.error("toggleFavorite error",o),m("‚ö†Ô∏è Failed toggling favorite","error")}}function oe(e){document.querySelectorAll("#timelineList .favorite-btn").forEach(t=>{const a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("click",r=>{r.stopPropagation();const n=a.closest(".event-card");if(!n)return;const i=Number(n.dataset.id),s=e.find(d=>d&&Number(d.id)===i);s&&te(s)})})}function ne(e){document.querySelectorAll("#timelineList .event-card").forEach(t=>{const a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("click",()=>{const r=Number(a.dataset.id),n=e.find(i=>i&&Number(i.id)===r);n&&$(n)})})}function T(e){oe(e),ne(e)}document.addEventListener("DOMContentLoaded",async()=>{await E("./src/partials/header.html","header-placeholder"),await E("./src/partials/footer.html","footer-placeholder"),W(),D();try{const o=await(await fetch("data/events.json")).json();let t=[];try{t=await _("World History")}catch(n){console.warn("API fetch failed:",n)}const a=[...(o||[]).slice(0,10),...(t||[]).slice(0,10)];f=[...[{id:9991,title:"Moon Landing",description:"Apollo 11 (1969).",image:"https://upload.wikimedia.org/wikipedia/commons/9/9c/Aldrin_Apollo_11.jpg",year:1969,lat:.67408,lng:23.47297,theme:"technology"},{id:9992,title:"French Revolution",description:"1789 - 1799.",image:"https://upload.wikimedia.org/wikipedia/commons/6/6f/Prise_de_la_Bastille.jpg",year:1789,lat:48.8566,lng:2.3522,theme:"revolution"}],...a].map((n,i)=>({id:n.id||i+1,title:n.title||"Untitled Event",description:n.description||"No description available.",image:n.image||"./src/assets/placeholder.png",year:n.year||null,lat:n.lat||null,lng:n.lng||null,theme:n.theme||"general"})),M(f),T(f),ee(f),await N()}catch(e){console.error("main load error",e),m("Failed to load events","error")}});
