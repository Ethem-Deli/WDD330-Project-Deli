import{getApps as E,initializeApp as q}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";import{getAuth as P}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";import{getFirestore as G,doc as k,getDoc as Y,setDoc as J}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();function z(e,o){const t=document.getElementById("globalSearch"),r=document.getElementById("searchBtn");if(!t||!r){console.warn("🔍 Search input or button not found.");return}const n=()=>{const a=t.value.trim().toLowerCase();if(!a){o(e);return}const i=e.filter(c=>{const p=c.title?.toLowerCase()||"",d=c.description?.toLowerCase()||"",s=c.year?.toString()||"",l=c.theme?.toLowerCase()||"";return p.includes(a)||d.includes(a)||s.includes(a)||l.includes(a)});o(i)};t.addEventListener("input",n),r.addEventListener("click",n)}function D(){const e=document.querySelectorAll(".event-card");if(!e.length)return;if(!("IntersectionObserver"in window)){e.forEach(t=>t.classList.add("animate-in"));return}const o=new IntersectionObserver((t,r)=>{t.forEach(n=>{n.isIntersecting&&(n.target.classList.add("animate-in"),r.unobserve(n.target))})},{threshold:.05});e.forEach(t=>{o.observe(t),t.getBoundingClientRect().top<window.innerHeight&&t.classList.add("animate-in")})}async function K(e="World History"){try{const o=`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages|extracts&exintro&explaintext&pithumbsize=500&generator=search&gsrsearch=${encodeURIComponent(e)}&gsrlimit=15`,r=await(await fetch(o)).json();if(!r.query){console.warn("⚠️ No Wikipedia data, falling back to local JSON");const n=await fetch("data/events.json");if(!n.ok)throw new Error("Local JSON not found");return await n.json()}return Object.values(r.query.pages).map((n,a)=>({id:n.pageid||a+1,title:n.title,description:n.extract?n.extract.slice(0,300):"No description available for this event.",image:n.thumbnail?.source||"assets/placeholder.png",year:V(n.extract)||1900+a,theme:W(n.title+" "+n.extract),lat:null,lng:null}))}catch(o){console.error("❌ fetchEvents failed:",o);try{const t=await fetch("data/events.json");if(!t.ok)throw new Error("Fallback JSON failed");return await t.json()}catch(t){return console.error("❌ Local fetch also failed:",t),[]}}}function V(e=""){const o=e.match(/\b(1[5-9]\d{2}|20\d{2})\b/);return o?parseInt(o[0]):null}function W(e=""){return e=e.toLowerCase(),e.includes("war")?"war":e.includes("revolution")?"revolution":e.includes("flight")||e.includes("technology")||e.includes("invention")?"technology":e.includes("exploration")||e.includes("discovery")?"exploration":"general"}function X(e,o=1e4){return new Promise((t,r)=>{if(window.google&&window.google.maps&&window.google.maps.importLibrary){t(window.google);return}const n=document.querySelector("script[data-google-maps-loader]");if(n){n.addEventListener("load",()=>{window.google?t(window.google):r(new Error("Google loaded but window.google missing"))}),n.addEventListener("error",r);return}const a="_gmaps_loader_callback_"+Date.now();window[a]=()=>{delete window[a],t(window.google)};const i=document.createElement("script");i.dataset.googleMapsLoader="1",i.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(e)}&callback=${a}&libraries=maps,marker`,i.async=!0,i.defer=!0,i.onerror=c=>{delete window[a],r(c)},document.head.appendChild(i),setTimeout(()=>{window.google||r(new Error("Google Maps load timeout"))},o)})}const b={apiKey:"AIzaSyB92OXlJn50jta9IHuY5czC937HMgYH2xs",authDomain:"historytimeline-wdd330.firebaseapp.com",projectId:"historytimeline-wdd330",storageBucket:"historytimeline-wdd330.appspot.com",messagingSenderId:"539673015003",appId:"1:539673015003:web:2621f434393950b78312fe",measurementId:"G-GV6LHVLN1R"},Q=["apiKey","authDomain","projectId","storageBucket","appId"],I=Q.filter(e=>!b[e]||b[e].includes("YOUR_"));I.length>0&&(console.error(`⚠️ Firebase configuration incomplete or missing keys: ${I.join(", ")}.`),console.warn("Please copy src/js/firebase-config.example.js → src/js/firebase-config.js and fill in your real Firebase credentials."));const M=E().length?E()[0]:q(b),x=P(M),O=G(M);function g(e,o="info"){window.showToast&&typeof window.showToast=="function"?window.showToast(e,o):console.log(`[Toast:${o}] ${e}`)}const A="favorites_v1";function L(){try{return JSON.parse(localStorage.getItem(A)||"[]")}catch{return[]}}function T(e){try{localStorage.setItem(A,JSON.stringify(e||[]))}catch(o){console.error("Failed saving local favorites:",o)}}async function Z(){try{const e=x.currentUser;if(!e)return null;const o=k(O,"favorites",e.uid),t=await Y(o);return t.exists()?t.data().items||[]:[]}catch(e){return console.warn("firebaseGetFavorites failed:",e),null}}async function $(){const e=await Z();return Array.isArray(e)?e:L()}async function F(e){try{const o=x.currentUser;if(T(e),o)try{const t=k(O,"favorites",o.uid);await J(t,{items:e},{merge:!0}),g("✅ Synced to your online favorites!","success")}catch(t){console.warn("Firestore save failed, fallback to local only:",t),g("⚠️ Saved locally (offline mode)","info")}}catch(o){console.error("Error saving favorites:",o),g("❌ Failed to save favorite.","error")}}function ee(){const e=L(),o=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=URL.createObjectURL(o),r=document.createElement("a");r.href=t,r.download="favorites.json",r.click(),URL.revokeObjectURL(t)}async function te(){const e=L(),o=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),t=`${location.origin}${location.pathname}?shared=${o}`;return await navigator.clipboard.writeText(t),g("📋 Share link copied to clipboard!","info"),t}function oe(){const e=new URLSearchParams(location.search);if(!e.has("shared"))return!1;try{const o=decodeURIComponent(escape(atob(e.get("shared")))),t=JSON.parse(o);return T(t),g("✅ Imported shared favorites!","success"),!0}catch(o){return console.error("loadSharedFavoritesFromQuery failed:",o),g("❌ Failed to import shared favorites.","error"),!1}}function ne(){const e=document.getElementById("hamburgerBtn"),o=document.getElementById("navMenu");!e||!o||(e.addEventListener("click",t=>{t.stopPropagation(),o.classList.toggle("open"),e.classList.toggle("active")}),o.querySelectorAll("a").forEach(t=>{t.addEventListener("click",()=>{o.classList.remove("open"),e.classList.remove("active")})}),document.addEventListener("click",t=>{!o.contains(t.target)&&!e.contains(t.target)&&(o.classList.remove("open"),e.classList.remove("active"))}))}function f(e,o="info",t=3e3){try{const r="toast-container";let n=document.getElementById(r);n||(n=document.createElement("div"),n.id=r,n.style.position="fixed",n.style.right="1rem",n.style.top="1rem",n.style.zIndex=99999,n.style.display="flex",n.style.flexDirection="column",n.style.gap="8px",document.body.appendChild(n));const a=document.createElement("div");a.className=`toast toast-${o}`,a.textContent=e,a.style.padding="10px 14px",a.style.borderRadius="8px",a.style.boxShadow="0 6px 20px rgba(0,0,0,0.12)",a.style.maxWidth="360px",a.style.fontSize="0.95rem",a.style.opacity="0",a.style.transform="translateY(-6px)",a.style.transition="opacity .18s, transform .18s",o==="success"?(a.style.background="#ecfdf5",a.style.color="#065f46"):o==="error"?(a.style.background="#fff1f2",a.style.color="#7f1d1d"):(a.style.background="#f3f4f6",a.style.color="#111827"),n.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"}),setTimeout(()=>{a.style.opacity="0",a.style.transform="translateY(-6px)",setTimeout(()=>a.remove(),220)},t)}catch(r){console.warn("toast error",r)}}function S(e,o){const t=document.getElementById("yearFilter"),r=document.getElementById("decadeFilter"),n=document.getElementById("themeFilter"),a=document.getElementById("clearFiltersBtn");if(!t||!r||!n){console.warn("⚠️ Filter elements not found in DOM.");return}const i=[...new Set(e.map(s=>s.year).filter(Boolean))].sort((s,l)=>s-l),c=[...new Set(e.map(s=>Math.floor(s.year/10)*10).filter(Boolean))].sort((s,l)=>s-l),p=[...new Set(e.map(s=>s.theme||"general"))];t.innerHTML='<option value="all">All Years</option>'+i.map(s=>`<option value="${s}">${s}</option>`).join(""),r.innerHTML='<option value="all">All Decades</option>'+c.map(s=>`<option value="${s}">${s}s</option>`).join(""),n.innerHTML='<option value="all">All Themes</option>'+p.map(s=>`<option value="${s}">${s}</option>`).join("");function d(){const s=t.value,l=r.value,m=n.value,u=e.filter(v=>{const H=s==="all"||String(v.year)===s,U=l==="all"||Math.floor(v.year/10)*10===Number(l),_=m==="all"||v.theme===m;return H&&U&&_});typeof o=="function"&&o(u)}t.addEventListener("change",d),r.addEventListener("change",d),n.addEventListener("change",d),a&&a.addEventListener("click",()=>{t.value="all",r.value="all",n.value="all",d()})}const y="AIzaSyDLwMRu47yXHBbfX4cimCx9BnIEtdmd0zk";window.showToast=f;let h=[];async function B(e,o){const t=document.getElementById(o);if(!t)return;const r=await fetch(e);t.innerHTML=await r.text()}function C(e=[]){const o=document.getElementById("timelineList");if(o){if(!e||e.length===0){o.innerHTML='<p class="no-results">No events found for your search.</p>';return}o.innerHTML="",e.forEach(t=>{const r=document.createElement("div");r.className="event-card entering",r.dataset.id=t.id,r.innerHTML=`
      <img src="${t.image}" alt="${t.title}" class="event-image">
      <div class="card-body">
        <h3>${t.title}</h3>
        <p>${(t.description||"").slice(0,100)}...</p>
      </div>
      <button class="favorite-btn ${t.isFavorite?"active":""}" title="Favorite">❤️</button>
    `,o.appendChild(r),requestAnimationFrame(()=>r.classList.remove("entering"))}),D()}}async function N(){const e=await $(),o=document.getElementById("favoritesList");o&&(o.innerHTML=`
    <div class="favorites-header">
      <h3>Your Favorites</h3>
      <div class="fav-actions">
        <button id="exportFavsBtn" class="btn-small">⬇️ Export</button>
        <button id="shareFavsBtn" class="btn-small">🔗 Share</button>
      </div>
    </div>
    ${e.length?e.map(t=>`
              <div class="event-card small" data-id="${t.id}">
                <img src="${t.image}" alt="${t.title}" class="event-image-small">
                <div class="card-body"><h4>${t.title}</h4></div>
              </div>`).join(""):"<p>No favorites yet ❤️</p>"}
  `,document.getElementById("exportFavsBtn")?.addEventListener("click",ee),document.getElementById("shareFavsBtn")?.addEventListener("click",async()=>{await te(),f("📋 Share link copied to clipboard!","success")}),ae(e))}function ae(e){document.querySelectorAll("#favoritesList .event-card.small").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();const n=Number(t.dataset.id),a=e.find(i=>i&&i.id===n);a&&j(a)})})}async function j(e){const o=document.getElementById("eventModal");if(!o||!e)return;const t=document.getElementById("modalTitle"),r=document.getElementById("modalImage"),n=document.getElementById("modalDescription"),a=document.getElementById("modalMap"),i=document.getElementById("modalFooter");t.textContent=e.title||"",r.src=e.image||"./src/assets/placeholder.png",n.textContent=e.description||"No description available.",a.innerHTML="Loading map...",i&&(i.innerHTML=""),o.style.display="block";try{if(!y||y.includes("YOUR_GOOGLE_MAPS_KEY")){a.innerHTML="<p>⚠️ Google Maps API key not set. Map cannot be displayed.</p>";return}await X(y);const{Map:c}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:p}=await google.maps.importLibrary("marker");let{lat:d,lng:s}=e;if(!d||!s)try{const m=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(e.title)}&key=${y}`)).json();if(m.status==="OK"&&m.results?.[0]){const u=m.results[0].geometry.location;d=u.lat,s=u.lng}}catch(l){console.warn("Geocode fallback failed",l)}if(d&&s){const l={lat:Number(d),lng:Number(s)},m=new c(a,{zoom:5,center:l,mapId:"DEMO_MAP_ID"});new p({map:m,position:l,title:e.title});const u=document.createElement("a");u.href=`https://www.google.com/maps?q=${l.lat},${l.lng}`,u.target="_blank",u.rel="noopener",u.textContent="📍 View on Google Maps",u.classList.add("map-link"),a.appendChild(u)}else a.innerHTML="<p>Location not available.</p>"}catch(c){console.error("Map render failed",c),a.innerHTML="<p>Map could not be loaded.</p>"}i&&(i.innerHTML='<button id="shareEventBtn" class="btn-small">🔗 Share this event</button>',document.getElementById("shareEventBtn")?.addEventListener("click",()=>{try{const p=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),d=`${location.origin}${location.pathname}?event=${p}`;navigator.clipboard.writeText(d),f("Event link copied to clipboard!","success")}catch{f("Failed to create share link","error")}}))}function w(){const e=document.getElementById("eventModal");e&&(e.style.display="none")}function re(){const e=document.getElementById("eventModal"),o=document.querySelector(".close");e&&(o&&o.addEventListener("click",w),e.addEventListener("click",t=>{t.target===e&&w()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&w()}))}function ie(e){try{if(typeof S=="function"){let o=[];S(e,t=>{const r=t.map(n=>n.id);JSON.stringify(r)!==JSON.stringify(o)&&(o=r,C(t),R(t))})}else z(e)}catch(o){console.warn("Filter initialization failed:",o)}}async function se(e){try{const o=await $(),t=o.find(n=>n&&n.id===e.id),r=document.querySelector(`.event-card[data-id="${e.id}"] .favorite-btn`);if(t){const n=o.filter(a=>a&&a.id!==e.id);await F(n),r?.classList.remove("active"),f("❌ Removed from favorites","error")}else o.push(e),await F(o),r?.classList.add("active"),f("✅ Added to favorites","success");await N()}catch(o){console.error("toggleFavorite error",o),f("⚠️ Failed toggling favorite","error")}}function ce(e){document.querySelectorAll("#timelineList .favorite-btn").forEach(t=>{t.addEventListener("click",async r=>{r.stopPropagation(),r.preventDefault();const n=t.closest(".event-card");if(!n)return;const a=Number(n.dataset.id),i=e.find(c=>c&&Number(c.id)===a);i&&await se(i)})})}function le(e){document.querySelectorAll("#timelineList .event-card").forEach(t=>{t.addEventListener("click",r=>{if(r.target.closest(".favorite-btn"))return;const n=Number(t.dataset.id),a=e.find(i=>i&&Number(i.id)===n);a&&j(a)})})}function R(e){ce(e),le(e)}document.addEventListener("DOMContentLoaded",async()=>{await B("./src/partials/header.html","header-placeholder"),await B("./src/partials/footer.html","footer-placeholder"),ne(),oe();try{const o=await(await fetch("data/events.json")).json();let t=[];try{t=await K("World History"),t=Array.isArray(t)?t.filter(r=>r&&r.title&&r.image):[]}catch(r){console.warn("API fetch failed:",r)}h=[...o,...t.map((r,n)=>({id:r.id||2e3+n,title:r.title,description:r.description,image:r.image,year:r.year,lat:r.lat,lng:r.lng,theme:r.theme||"general"}))],C(h),R(h),ie(h),await N(),re()}catch(e){console.error("main load error",e),f("Failed to load events","error")}});
