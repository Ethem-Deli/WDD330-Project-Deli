import{getApps as b,initializeApp as U}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";import{getAuth as H}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";import{getFirestore as _}from"https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function q(e,o){const t=document.getElementById("globalSearch"),a=document.getElementById("searchBtn");if(!t||!a){console.warn("🔍 Search input or button not found.");return}const n=()=>{const r=t.value.trim().toLowerCase();if(!r){o(e);return}const i=e.filter(c=>{const f=c.title?.toLowerCase()||"",l=c.description?.toLowerCase()||"",s=c.year?.toString()||"",d=c.theme?.toLowerCase()||"";return f.includes(r)||l.includes(r)||s.includes(r)||d.includes(r)});o(i)};t.addEventListener("input",n),a.addEventListener("click",n)}function G(){const e=document.querySelectorAll(".event-card");if(!e.length)return;if(!("IntersectionObserver"in window)){e.forEach(t=>t.classList.add("animate-in"));return}const o=new IntersectionObserver((t,a)=>{t.forEach(n=>{n.isIntersecting&&(n.target.classList.add("animate-in"),a.unobserve(n.target))})},{threshold:.05});e.forEach(t=>{o.observe(t),t.getBoundingClientRect().top<window.innerHeight&&t.classList.add("animate-in")})}async function Y(e="World History"){try{const o=`https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages|extracts&exintro&explaintext&pithumbsize=500&generator=search&gsrsearch=${encodeURIComponent(e)}&gsrlimit=15`,a=await(await fetch(o)).json();if(!a.query){console.warn("⚠️ No Wikipedia data, falling back to local JSON");const n=await fetch("data/events.json");if(!n.ok)throw new Error("Local JSON not found");return await n.json()}return Object.values(a.query.pages).map((n,r)=>({id:n.pageid||r+1,title:n.title,description:n.extract?n.extract.slice(0,300):"No description available for this event.",image:n.thumbnail?.source||"assets/placeholder.png",year:D(n.extract)||1900+r,theme:J(n.title+" "+n.extract),lat:null,lng:null}))}catch(o){console.error("❌ fetchEvents failed:",o);try{const t=await fetch("data/events.json");if(!t.ok)throw new Error("Fallback JSON failed");return await t.json()}catch(t){return console.error("❌ Local fetch also failed:",t),[]}}}function D(e=""){const o=e.match(/\b(1[5-9]\d{2}|20\d{2})\b/);return o?parseInt(o[0]):null}function J(e=""){return e=e.toLowerCase(),e.includes("war")?"war":e.includes("revolution")?"revolution":e.includes("flight")||e.includes("technology")||e.includes("invention")?"technology":e.includes("exploration")||e.includes("discovery")?"exploration":"general"}function z(e,o=1e4){return new Promise((t,a)=>{if(window.google&&window.google.maps&&window.google.maps.importLibrary){t(window.google);return}const n=document.querySelector("script[data-google-maps-loader]");if(n){n.addEventListener("load",()=>{window.google?t(window.google):a(new Error("Google loaded but window.google missing"))}),n.addEventListener("error",a);return}const r="_gmaps_loader_callback_"+Date.now();window[r]=()=>{delete window[r],t(window.google)};const i=document.createElement("script");i.dataset.googleMapsLoader="1",i.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(e)}&callback=${r}&libraries=maps,marker`,i.async=!0,i.defer=!0,i.onerror=c=>{delete window[r],a(c)},document.head.appendChild(i),setTimeout(()=>{window.google||a(new Error("Google Maps load timeout"))},o)})}const K="modulepreload",V=function(e){return"/"+e},E={},W=function(o,t,a){let n=Promise.resolve();if(t&&t.length>0){let f=function(l){return Promise.all(l.map(s=>Promise.resolve(s).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=i?.nonce||i?.getAttribute("nonce");n=f(t.map(l=>{if(l=V(l),l in E)return;E[l]=!0;const s=l.endsWith(".css"),d=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const u=document.createElement("link");if(u.rel=s?"stylesheet":K,s||(u.as="script"),u.crossOrigin="",u.href=l,c&&u.setAttribute("nonce",c),document.head.appendChild(u),s)return new Promise((m,h)=>{u.addEventListener("load",m),u.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return n.then(i=>{for(const c of i||[])c.status==="rejected"&&r(c.reason);return o().catch(r)})},L={apiKey:"AIzaSyB92OXlJn50jta9IHuY5czC937HMgYH2xs",authDomain:"historytimeline-wdd330.firebaseapp.com",projectId:"historytimeline-wdd330",storageBucket:"historytimeline-wdd330.appspot.com",messagingSenderId:"539673015003",appId:"1:539673015003:web:2621f434393950b78312fe",measurementId:"G-GV6LHVLN1R"},X=["apiKey","authDomain","projectId","storageBucket","appId"],I=X.filter(e=>!L[e]||L[e].includes("YOUR_"));I.length>0&&(console.error(`⚠️ Firebase configuration incomplete or missing keys: ${I.join(", ")}.`),console.warn("Please copy src/js/firebase-config.example.js → src/js/firebase-config.js and fill in your real Firebase credentials."));const A=b().length?b()[0]:U(L),S=H(A),F=_(A),C="historytimeline:favorites";function g(e,o="info"){window.showToast?window.showToast(e,o):console.log(`[Toast:${o}] ${e}`)}function w(){try{const e=localStorage.getItem(C),o=e?JSON.parse(e):[];return Array.isArray(o)?o:[]}catch(e){return console.error("getFavoritesForCurrentUser failed:",e),[]}}async function O(e){try{if(localStorage.setItem(C,JSON.stringify(e||[])),F&&S?.currentUser){const{doc:o,setDoc:t}=await W(async()=>{const{doc:a,setDoc:n}=await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js");return{doc:a,setDoc:n}},[]);await t(o(F,"users",S.currentUser.uid),{favorites:e},{merge:!0})}return!0}catch(o){return console.error("saveFavoritesForCurrentUser failed:",o),g("⚠️ Failed to save favorites","error"),!1}}function Q(){try{const e=w(),o=JSON.stringify(e,null,2),t=new Blob([o],{type:"application/json"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download="favorites.json",n.click(),URL.revokeObjectURL(a),g("✅ Favorites exported","success")}catch(e){g("❌ Failed to export","error"),console.error(e)}}async function Z(){try{const e=w(),o=btoa(encodeURIComponent(JSON.stringify(e))),t=new URL(location.href);t.searchParams.set("shared",o);const a=t.toString();return await navigator.clipboard.writeText(a),g("🔗 Share link copied!","success"),a}catch(e){g("❌ Failed to share favorites","error"),console.error(e)}}function ee(){const e=new URLSearchParams(location.search);if(!e.has("shared"))return[];try{const o=decodeURIComponent(atob(e.get("shared"))),t=JSON.parse(o);return Array.isArray(t)?(O(t),g("✅ Imported shared favorites!","success"),t):[]}catch(o){return g("❌ Invalid shared favorites","error"),console.error(o),[]}}function te(){const e=document.getElementById("hamburgerBtn"),o=document.getElementById("navMenu");!e||!o||(e.addEventListener("click",t=>{t.stopPropagation(),o.classList.toggle("open"),e.classList.toggle("active")}),o.querySelectorAll("a").forEach(t=>{t.addEventListener("click",()=>{o.classList.remove("open"),e.classList.remove("active")})}),document.addEventListener("click",t=>{!o.contains(t.target)&&!e.contains(t.target)&&(o.classList.remove("open"),e.classList.remove("active"))}))}function p(e,o="info",t=3e3){try{const a="toast-container";let n=document.getElementById(a);n||(n=document.createElement("div"),n.id=a,n.style.position="fixed",n.style.right="1rem",n.style.top="1rem",n.style.zIndex=99999,n.style.display="flex",n.style.flexDirection="column",n.style.gap="8px",document.body.appendChild(n));const r=document.createElement("div");r.className=`toast toast-${o}`,r.textContent=e,r.style.padding="10px 14px",r.style.borderRadius="8px",r.style.boxShadow="0 6px 20px rgba(0,0,0,0.12)",r.style.maxWidth="360px",r.style.fontSize="0.95rem",r.style.opacity="0",r.style.transform="translateY(-6px)",r.style.transition="opacity .18s, transform .18s",o==="success"?(r.style.background="#ecfdf5",r.style.color="#065f46"):o==="error"?(r.style.background="#fff1f2",r.style.color="#7f1d1d"):(r.style.background="#f3f4f6",r.style.color="#111827"),n.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translateY(0)"}),setTimeout(()=>{r.style.opacity="0",r.style.transform="translateY(-6px)",setTimeout(()=>r.remove(),220)},t)}catch(a){console.warn("toast error",a)}}function k(e,o){const t=document.getElementById("yearFilter"),a=document.getElementById("decadeFilter"),n=document.getElementById("themeFilter"),r=document.getElementById("clearFiltersBtn");if(!t||!a||!n){console.warn("⚠️ Filter elements not found in DOM.");return}const i=[...new Set(e.map(s=>s.year).filter(Boolean))].sort((s,d)=>s-d),c=[...new Set(e.map(s=>Math.floor(s.year/10)*10).filter(Boolean))].sort((s,d)=>s-d),f=[...new Set(e.map(s=>s.theme||"general"))];t.innerHTML='<option value="all">All Years</option>'+i.map(s=>`<option value="${s}">${s}</option>`).join(""),a.innerHTML='<option value="all">All Decades</option>'+c.map(s=>`<option value="${s}">${s}s</option>`).join(""),n.innerHTML='<option value="all">All Themes</option>'+f.map(s=>`<option value="${s}">${s}</option>`).join("");function l(){const s=t.value,d=a.value,u=n.value,m=e.filter(h=>{const j=s==="all"||String(h.year)===s,R=d==="all"||Math.floor(h.year/10)*10===Number(d),P=u==="all"||h.theme===u;return j&&R&&P});typeof o=="function"&&o(m)}t.addEventListener("change",l),a.addEventListener("change",l),n.addEventListener("change",l),r&&r.addEventListener("click",()=>{t.value="all",a.value="all",n.value="all",l()})}const y="AIzaSyDLwMRu47yXHBbfX4cimCx9BnIEtdmd0zk";window.showToast=p;let v=[];async function B(e,o){const t=document.getElementById(o);if(!t)return;const a=await fetch(e);t.innerHTML=await a.text()}function T(e=[]){const o=document.getElementById("timelineList");if(o){if(!e||e.length===0){o.innerHTML='<p class="no-results">No events found for your search.</p>';return}o.innerHTML="",e.forEach(t=>{const a=document.createElement("div");a.className="event-card entering",a.dataset.id=t.id,a.innerHTML=`
      <img src="${t.image}" alt="${t.title}" class="event-image">
      <div class="card-body">
        <h3>${t.title}</h3>
        <p>${(t.description||"").slice(0,100)}...</p>
      </div>
      <button class="favorite-btn ${t.isFavorite?"active":""}" title="Favorite">❤️</button>
    `,o.appendChild(a),requestAnimationFrame(()=>a.classList.remove("entering"))}),G()}}async function oe(){const e=await w(),o=document.getElementById("favoritesList");o&&(o.innerHTML=`
    <div class="favorites-header">
      <h3>Your Favorites</h3>
      <div class="fav-actions">
        <button id="exportFavsBtn" class="btn-small">⬇️ Export</button>
        <button id="shareFavsBtn" class="btn-small">🔗 Share</button>
      </div>
    </div>
    ${e.length?e.map(t=>`
              <div class="event-card small" data-id="${t.id}">
                <img src="${t.image}" alt="${t.title}" class="event-image-small">
                <div class="card-body"><h4>${t.title}</h4></div>
              </div>`).join(""):"<p>No favorites yet ❤️</p>"}
  `,document.getElementById("exportFavsBtn")?.addEventListener("click",Q),document.getElementById("shareFavsBtn")?.addEventListener("click",async()=>{await Z(),p("📋 Share link copied to clipboard!","success")}),ne(e))}function ne(e){document.querySelectorAll("#favoritesList .event-card.small").forEach(t=>{t.addEventListener("click",a=>{a.stopPropagation();const n=Number(t.dataset.id),r=e.find(i=>i&&i.id===n);r&&$(r)})})}async function $(e){const o=document.getElementById("eventModal");if(!o||!e)return;const t=document.getElementById("modalTitle"),a=document.getElementById("modalImage"),n=document.getElementById("modalDescription"),r=document.getElementById("modalMap"),i=document.getElementById("modalFooter");t.textContent=e.title||"",a.src=e.image||"./src/assets/placeholder.png",n.textContent=e.description||"No description available.",r.innerHTML="Loading map...",i&&(i.innerHTML=""),o.style.display="block",o.classList.remove("closing");try{if(!y||y.includes("YOUR_GOOGLE_MAPS_KEY")){r.innerHTML="<p>⚠️ Google Maps API key not set. Map cannot be displayed.</p>";return}await z(y);const{Map:c}=await google.maps.importLibrary("maps"),{AdvancedMarkerElement:f}=await google.maps.importLibrary("marker");let{lat:l,lng:s}=e;if(!l||!s)try{const u=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(e.title)}&key=${y}`)).json();if(u.status==="OK"&&u.results?.[0]){const m=u.results[0].geometry.location;l=m.lat,s=m.lng}}catch(d){console.warn("Geocode fallback failed",d)}if(l&&s){const d={lat:Number(l),lng:Number(s)},u=new c(r,{zoom:5,center:d,mapId:"DEMO_MAP_ID"});new f({map:u,position:d,title:e.title});const m=document.createElement("a");m.href=`https://www.google.com/maps?q=${d.lat},${d.lng}`,m.target="_blank",m.rel="noopener",m.textContent="📍 View on Google Maps",m.classList.add("map-link"),r.appendChild(m)}else r.innerHTML="<p>Location not available.</p>"}catch(c){console.error("Map render failed",c),r.innerHTML="<p>Map could not be loaded.</p>"}i&&(i.innerHTML='<button id="shareEventBtn" class="btn-small">🔗 Share this event</button>',document.getElementById("shareEventBtn")?.addEventListener("click",()=>{try{const f=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),l=`${location.origin}${location.pathname}?event=${f}`;navigator.clipboard.writeText(l),p("Event link copied to clipboard!","success")}catch{p("Failed to create share link","error")}}))}function M(){const e=document.getElementById("eventModal");e&&(e.classList.add("closing"),setTimeout(()=>{e.style.display="none",e.classList.remove("closing")},200))}function x(){const e=document.getElementById("eventModal");e&&(e.addEventListener("click",o=>{(o.target.classList.contains("close")||o.target===e)&&M()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&e.style.display==="block"&&M()}))}window.addEventListener("load",x);function re(e){try{if(typeof k=="function"){let o=[];k(e,t=>{const a=t.map(n=>n.id);JSON.stringify(a)!==JSON.stringify(o)&&(o=a,T(t),N(t))})}else q(e)}catch(o){console.warn("Filter initialization failed:",o)}}async function ae(e){try{let o=w();const t=o.some(n=>n.id===e.id),a=document.querySelector(`.event-card[data-id="${e.id}"] .favorite-btn`);t?(o=o.filter(n=>n.id!==e.id),a?.classList.remove("active"),p("❌ Removed from favorites","error")):(o.push(e),a?.classList.add("active"),p("✅ Added to favorites","success")),await O(o)}catch(o){console.error(o),p("⚠️ Failed to toggle favorite","error")}}function ie(e){document.querySelectorAll("#timelineList .favorite-btn").forEach(t=>{t.addEventListener("click",async a=>{a.stopPropagation(),a.preventDefault();const n=t.closest(".event-card");if(!n)return;const r=Number(n.dataset.id),i=e.find(c=>c&&Number(c.id)===r);i&&await ae(i)})})}function se(e){document.querySelectorAll("#timelineList .event-card").forEach(t=>{t.addEventListener("click",a=>{if(a.target.closest(".favorite-btn"))return;const n=Number(t.dataset.id),r=e.find(i=>i&&Number(i.id)===n);r&&$(r)})})}function N(e){ie(e),se(e)}document.addEventListener("DOMContentLoaded",async()=>{await B("./src/partials/header.html","header-placeholder"),await B("./src/partials/footer.html","footer-placeholder"),te(),ee();try{let e=[];try{let t="";window.location.origin.includes("github.io")?t=`${window.location.origin}/WDD330-Project-Deli/data/events.json`:t="./data/events.json",console.log("Fetching events from:",t);const a=await fetch(t);if(!a.ok)throw new Error(`Failed to load: ${t}`);e=await a.json(),e=e.map(n=>({...n,image:n.image?.startsWith("http")?n.image:`./images/${n.image}`})),console.log("✅ Local events loaded:",e.length)}catch(t){console.error("⚠️ Local events load failed:",t),e=[]}let o=[];try{o=await Y("World History"),o=Array.isArray(o)?o.filter(t=>t&&t.title&&t.image):[]}catch(t){console.warn("API fetch failed:",t)}v=[...e,...o.map((t,a)=>({id:t.id||2e3+a,title:t.title,description:t.description,image:t.image,year:t.year,lat:t.lat,lng:t.lng,theme:t.theme||"general"}))],T(v),N(v),re(v),await oe(),x()}catch(e){console.error("main load error",e),p("Failed to load events","error")}});
